@{
    Layout = "/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Modules";

    Html.Resources<ModuleStateEnum>();
}

@section BodyScripts
{
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial"); }

    <script type="text/javascript">
        piSensorNet.Net.on('NewModule',
            function(iModuleID, sModuleAddress) {
                console.log('OnNewModule: ' + iModuleID + ', ' + sModuleAddress);

                $('table#modulesTable').DataTable().ajax.reload();
            });

        $(document)
            .ready(function() {

                $('table#modulesTable')
                    .dataTable({
                        'title': 'Modules',
                        'ajax': {
                            'url': '@(Url.Action("List"))',
                            'contentType': 'application/json',
                            'dataType ': 'json',
                            'data': function(oData, oAjaxSettings) {
                                return JSON.stringify(oData);
                            }
                        },
                        'searching': false,
                        'paging': false,

                        'columns': [
                            { 'data': 'ID', 'type': 'num', 'visible': false },
                            { 'data': 'Address', 'type': 'string' },
                            { 'data': 'FriendlyName', 'type': 'string' },
                            {
                                'data': 'State',
                                'type': 'string',
                                'render': piSensorNet.DataTables.enumLocalizer('@(Html.ResourcePrefix<Enums, ModuleStateEnum>())')
                            },
                            {
                                'data': 'Created',
                                'type': 'date',
                                'render': piSensorNet.DataTables.dateFormatter()
                            },
                            piSensorNet.DataTables.actions({
                                'edit': {
                                    'title': 'Edit',
                                    'text': $('<span />').addClass('fa').addClass('fa-pencil-square-o'),
                                    'handler': function(settings, rowIndex, columnIndex, data) {
                                        var url = '@(Url.Action("Edit", "Modules", "Manage"))/' +
                                            data['@(nameof(ModuleListItemModel.ID))'];
                                        var title = 'Edit module @@' + data['@(nameof(ModuleListItemModel.Address))'];

                                        piSensorNet.Dialog.editor(url, title,
                                            function() {
                                                settings.oInstance.api().ajax.reload();
                                            });
                                    }
                                },
                                'identify': {
                                    'title': 'Identify',
                                    'text': $('<span />').addClass('fa').addClass('fa-hand-spock-o'),
                                    'handler': function(settings, rowIndex, columnIndex, data) {
                                        var id = data && data['@(nameof(ModuleListItemModel.ID))'];

                                        piSensorNet.Net.call('@(nameof(IMainHubClient.Identify))', [id]);
                                    }
                                }
                            })
                        ],
                        'sorting': [[1, 'asc']]
                    });
            });
    </script>
}

<div class="row">
    <table id="modulesTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Address</th>
                <th>Friendly Name</th>
                <th>State</th>
                <th>Created</th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr>
                <th colspan="5"></th>
                <th><a data-action="identify" data-action-text="true" title="Identify All"></a></th>
            </tr>
        </tfoot>
    </table>
</div>